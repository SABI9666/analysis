from IPython.display import HTML, display

# HTML content for the dashboard
# --- IMPORTANT ---
# Remember to replace the placeholder Google Sheet URLs below with YOUR OWN
# published CSV URLs from Google Sheets.
# Go to your Google Sheet > File > Share > Publish to web > Select CSV > Copy URL.
html_content = '''
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production Analytics Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        /* Basic reset for all elements */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        /* Body styling with a gradient background, minimum height, and padding */
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
        }
        /* Container for centralizing content with a maximum width */
        .container { max-width: 1200px; margin: 0 auto; }
        /* Header styling for title and subtitle */
        .header { text-align: center; color: white; margin-bottom: 25px; }
        .header h1 { font-size: 2rem; text-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        /* Styling for control panel and dashboard sections */
        .control-panel, .dashboard {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        /* Button styling with a gradient background */
        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
        }
        /* Hover effect for buttons */
        .btn:hover { opacity: 0.9; }
        /* Styling for select dropdowns */
        select {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 5px;
        }
        /* Grid layout for statistic cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        /* Styling for individual statistic cards */
        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        /* Styling for the value in stat cards */
        .stat-value { font-size: 1.8rem; font-weight: 700; }
        /* Grid layout for charts */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        /* Styling for chart containers */
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 15px;
            height: 350px;
        }
        /* Styling for chart titles */
        .chart-title { font-size: 1.1rem; font-weight: 700; text-align: center; margin-bottom: 10px; }
        /* Grid layout for analysis sections */
        .analysis-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* Adjusted for more flexibility */
            gap: 20px;
        }
        /* Styling for analysis cards */
        .analysis-card {
            background: #f0f9ff;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #0284c7;
        }
        /* Styling for individual operator items in analysis cards */
        .operator-item {
            background: rgba(255,255,255,0.9);
            margin: 8px 0;
            padding: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
        }
        /* Loading message styling */
        #loadingMessage {
            text-align: center;
            color: white;
            margin-top: 20px;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè≠ Production Analytics</h1>
            <p>Quantity & Performance Dashboard</p>
        </div>

        <div class="control-panel">
            <button class="btn" onclick="loadData()">üöÄ Load Data</button>
            <select id="weekSelector" onchange="selectWeek(this.value)">
                <option value="">üìÖ Select Week...</option>
            </select>
            <button class="btn" onclick="refreshData()">üîÑ Refresh</button>
        </div>

        <div id="loadingMessage" style="display: none;">Loading data...</div>

        <div class="dashboard">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalTonnage">0</div>
                    <div>Total Quantity</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="fabricationTonnage">0</div>
                    <div>Fabrication Qty</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="machiningTonnage">0</div>
                    <div>Machining Qty</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="scrapTonnage">0</div>
                    <div>Total Scrap</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalOperators">0</div>
                    <div>Operators</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgTonnage">0</div>
                    <div>Avg Qty/Operator</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-title">üìä Activity Performance (Quantity)</div>
                    <canvas id="activityChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">üë• Operator Output (Quantity)</div>
                    <canvas id="operatorChart"></canvas>
                </div>
                 <div class="chart-container">
                    <div class="chart-title">‚öôÔ∏è Fab vs Machining (Quantity)</div>
                    <canvas id="comparisonChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">üóëÔ∏è Scrap by Activity</div>
                    <canvas id="scrapActivityChart"></canvas>
                </div>
            </div>

            <div class="analysis-section">
                <div class="analysis-card">
                    <h3>üèÜ Top Performers (Quantity & Scrap)</h3>
                    <div id="topOperators"></div>
                </div>
                <div class="analysis-card">
                    <h3>üìä Overall Scrap Analysis</h3>
                    <div id="overallScrapAnalysis"></div>
                </div>
                <div class="analysis-card">
                    <h3>üìâ Scrap by Activity Details</h3>
                    <div id="activityScrapAnalysis"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DATA will now be populated from a fetch request
        let DATA = { fab: [], mach: [] };
        let processedData = {}, charts = {}, selectedWeekData = null;
        const loadingMessage = document.getElementById('loadingMessage');

        // URLs for your CSV data from Google Sheets
        // Ensure these URLs are 'published to the web' as CSV
        // !!! IMPORTANT: Replace these with your actual Google Sheet URLs !!!
        const FABRICATION_DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTLU1qKMHsLrjlAcnGj3oKUzWxIFnbiHBtvQ8BJFFgZzl0BMkxUlYVZYgN7mtIuQ0acVWjLi69Etbr7/pub?gid=1496141867&single=true&output=csv';
        const MACHINING_DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTLU1qKMHsLrjlAcnGj3oKUzWxIFnbiHBtvQ8BJFFgZzl0BMkxUlYVZYgN7mtIuQ0acVWjLi69Etbr7/pub?gid=1704946606&single=true&output=csv';

        /**
         * Parses CSV text into an array of objects.
         * Assumes the first row is the header.
         * @param {string} csvText - The CSV data as a string.
         * @param {string} sheetType - 'fab' or 'mach' to handle different headers.
         * @returns {Array<Object>} An array of objects, where each object represents a row.
         */
        function parseCSV(csvText, sheetType) {
            console.log(`Starting parseCSV for ${sheetType} sheet...`);
            const lines = csvText.trim().split('\\n'); // Use \\n for multiline string in Python
            if (lines.length === 0) {
                console.warn(`CSV text for ${sheetType} is empty.`);
                return [];
            }

            const headers = lines[0].split(',').map(header => header.trim());
            console.log(`CSV Headers for ${sheetType}:`, headers);

            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(value => value.trim());
                if (values.length !== headers.length) {
                    console.warn(`Skipping malformed CSV row for ${sheetType} (column count mismatch):`, lines[i]);
                    continue;
                }
                const rowObject = {};
                headers.forEach((header, index) => {
                    let value = values[index];
                    // Convert Qty and Scrap to numbers
                    if (header === 'Qty' || header === 'Scrap') {
                            const parsedValue = parseFloat(value);
                            rowObject[header] = isNaN(parsedValue) ? 0 : parsedValue; // Default to 0 if NaN or empty
                            if (isNaN(parsedValue) && value !== '') {
                                console.warn(`Could not parse "${value}" as number for header "${header}". Defaulting to 0.`);
                            }
                    } else {
                        rowObject[header] = value;
                    }
                });
                data.push(rowObject);
            }
            console.log(`Parsed Data for ${sheetType} (first 5 rows):`, data.slice(0, 5));
            return data;
        }

        /**
         * Calculates the week number for a given date string.
         * @param {string} dateStr - The date string in 'YYYY-MM-DD' format.
         * @returns {string} The week string in 'YYYY-WNN' format.
         */
        function getWeekString(dateStr) {
            const date = new Date(dateStr);
            // Ensure date is valid before proceeding
            if (isNaN(date.getTime())) {
                console.warn(`Invalid date string: "${dateStr}". Returning empty week string.`);
                return '';
            }

            const year = date.getFullYear();
            const onejan = new Date(year, 0, 1);
            // Calculate week number based on days since Jan 1st
            const week = Math.ceil((((date - onejan) / 86400000) + onejan.getDay() + 1) / 7);
            return `${year}-W${week.toString().padStart(2, '0')}`;
        }

        /**
         * Fetches data, processes it, and populates the week selector.
         * This function now fetches from two separate CSV URLs.
         */
        async function loadData() {
            loadingMessage.style.display = 'block'; // Show loading message
            loadingMessage.textContent = 'Loading data...';
            console.log('Attempting to load data from Google Sheets...');
            try {
                // Fetch Fabrication data
                console.log('Fetching Fabrication data from:', FABRICATION_DATA_URL);
                const fabResponse = await fetch(FABRICATION_DATA_URL);
                if (!fabResponse.ok) {
                    throw new Error(`HTTP error! status: ${fabResponse.status} for Fabrication data`);
                }
                const fabCsvText = await fabResponse.text();
                console.log('Fetched Fabrication CSV text (first 500 chars):', fabCsvText.substring(0, 500));
                DATA.fab = parseCSV(fabCsvText, 'fab');
                console.log('Processed DATA.fab:', DATA.fab.length > 0 ? 'Data loaded.' : 'No data loaded.');


                // Fetch Machining data
                console.log('Fetching Machining data from:', MACHINING_DATA_URL);
                const machResponse = await fetch(MACHINING_DATA_URL);
                if (!machResponse.ok) {
                    throw new Error(`HTTP error! status: ${machResponse.status} for Machining data`);
                }
                const machCsvText = await machResponse.text();
                console.log('Fetched Machining CSV text (first 500 chars):', machCsvText.substring(0, 500));
                DATA.mach = parseCSV(machCsvText, 'mach');
                console.log('Processed DATA.mach:', DATA.mach.length > 0 ? 'Data loaded.' : 'No data loaded.');

                // Ensure DATA has both fab and mach properties, even if empty
                DATA.fab = DATA.fab || [];
                DATA.mach = DATA.mach || [];

                const weeks = {};
                // Process fabrication data and group by week
                DATA.fab.forEach(row => {
                    if (row.Date) { // Ensure Date property exists
                        const week = getWeekString(row.Date);
                        if (week) { // Only process if week string is valid
                            if (!weeks[week]) weeks[week] = { fab: [], mach: [] };
                            weeks[week].fab.push(row);
                        }
                    } else {
                         console.warn('Fabrication row missing "Date" property:', row);
                    }
                });
                // Process machining data and group by week
                DATA.mach.forEach(row => {
                    if (row.Date) { // Ensure Date property exists
                        const week = getWeekString(row.Date);
                        if (week) { // Only process if week string is valid
                            if (!weeks[week]) weeks[week] = { fab: [], mach: [] };
                            weeks[week].mach.push(row);
                        }
                    } else {
                        console.warn('Machining row missing "Date" property:', row);
                    }
                });

                const weeksList = Object.keys(weeks).sort().reverse(); // Sort weeks descending
                processedData = weeks; // Store processed data
                console.log('Available Weeks:', weeksList);

                const selector = document.getElementById('weekSelector');
                selector.innerHTML = '<option value="">üìÖ Select Week...</option>'; // Clear existing options
                // Populate the week selector dropdown
                weeksList.forEach(week => {
                    const option = document.createElement('option');
                    option.value = week;
                    option.textContent = week;
                    selector.appendChild(option);
                });

                // Automatically select the most recent week if available
                if (weeksList.length > 0) {
                    selector.value = weeksList[0];
                    selectWeek(weeksList[0]);
                } else {
                    console.warn('No weeks found in data. Dashboard will be empty.');
                    // Clear dashboard if no data is available
                    selectedWeekData = null;
                    updateDashboard();
                    updateCharts();
                    updateAnalysis();
                }

            } catch (error) {
                console.error("Could not fetch or process data:", error);
                loadingMessage.textContent = 'Failed to load data. Please check console for errors and ensure Google Sheets are published correctly as CSV.';
            } finally {
                loadingMessage.style.display = 'none'; // Hide loading message
            }
        }

        /**
         * Selects a week and updates the dashboard, charts, and analysis sections.
         * @param {string} week - The selected week string (e.g., '2024-W01').
         */
        function selectWeek(week) {
            if (!week) {
                selectedWeekData = null;
                console.log('No week selected. Clearing dashboard.');
                updateDashboard();
                updateCharts();
                updateAnalysis();
                return;
            }
            selectedWeekData = processedData[week]; // Set the data for the selected week
            console.log('Selected week data:', selectedWeekData);
            updateDashboard(); // Update key statistics
            updateCharts();    // Update all charts
            updateAnalysis();  // Update analysis sections
        }

        /**
         * Updates the key performance indicator (KPI) cards on the dashboard.
         * Calculates total quantity, fabrication, machining, scrap, operators, and average quantity per operator.
         */
        function updateDashboard() {
            if (!selectedWeekData) { // Clear display if no data
                document.getElementById('totalTonnage').textContent = '0';
                document.getElementById('fabricationTonnage').textContent = '0';
                document.getElementById('machiningTonnage').textContent = '0';
                document.getElementById('scrapTonnage').textContent = '0';
                document.getElementById('totalOperators').textContent = '0';
                document.getElementById('avgTonnage').textContent = '0';
                return;
            }

            // Calculate totals for fabrication, machining, and scrap
            const fabTotalQty = selectedWeekData.fab.reduce((sum, row) => sum + (row.Qty || 0), 0);
            const machTotalQty = selectedWeekData.mach.reduce((sum, row) => sum + (row.Qty || 0), 0);
            const scrapTotal = selectedWeekData.fab.reduce((sum, row) => sum + (row.Scrap || 0), 0);

            // Count unique operators
            const operators = new Set([
                ...selectedWeekData.fab.map(r => r.Operator).filter(Boolean), // Filter out null/undefined operators
                ...selectedWeekData.mach.map(r => r.Operator).filter(Boolean)
            ]).size;

            // Update the display for each KPI
            document.getElementById('totalTonnage').textContent = (fabTotalQty + machTotalQty).toFixed(1);
            document.getElementById('fabricationTonnage').textContent = fabTotalQty.toFixed(1);
            document.getElementById('machiningTonnage').textContent = machTotalQty.toFixed(1);
            document.getElementById('scrapTonnage').textContent = scrapTotal.toFixed(1);
            document.getElementById('totalOperators').textContent = operators;
            document.getElementById('avgTonnage').textContent = operators > 0 ? ((fabTotalQty + machTotalQty) / operators).toFixed(1) : '0.0';
        }

        /**
         * Updates all Chart.js graphs (Activity Performance, Operator Output, Fab vs Machining, Scrap by Activity).
         * Destroys existing chart instances before creating new ones to prevent memory leaks.
         */
        function updateCharts() {
            // Destroy existing chart instances to free up memory and prevent conflicts
            Object.values(charts).forEach(chart => chart && chart.destroy());
            charts = {}; // Reset charts object
            console.log('Updating charts...');

            if (!selectedWeekData || (selectedWeekData.fab.length === 0 && selectedWeekData.mach.length === 0)) {
                console.warn('No data for selected week to update charts.');
                return; // Do nothing if no week data is selected or it's empty
            }

            // Prepare data for Activity Performance chart (Pie chart)
            const activityQtyData = {};
            selectedWeekData.fab.forEach(row => {
                activityQtyData[row['Activity Type']] = (activityQtyData[row['Activity Type']] || 0) + (row.Qty || 0);
            });
            console.log('Activity Quantity Data for Chart:', activityQtyData);

            charts.activity = new Chart(document.getElementById('activityChart'), {
                type: 'pie',
                data: {
                    labels: Object.keys(activityQtyData),
                    datasets: [{
                        data: Object.values(activityQtyData),
                        backgroundColor: ['#ff6b6b', '#4ecdc4', '#45b7d1', '#a262cc', '#f1c40f'],
                        hoverOffset: 4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
            });

            // Prepare data for Operator Output chart (bar chart)
            const operatorData = {};
            selectedWeekData.fab.forEach(row => {
                operatorData[row.Operator] = (operatorData[row.Operator] || 0) + (row.Qty || 0);
            });
            // Include machining operators as well
            selectedWeekData.mach.forEach(row => {
                operatorData[row.Operator] = (operatorData[row.Operator] || 0) + (row.Qty || 0);
            });
            console.log('Operator Quantity Data for Chart:', operatorData);

            charts.operator = new Chart(document.getElementById('operatorChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(operatorData),
                    datasets: [{
                        data: Object.values(operatorData),
                        backgroundColor: '#667eea',
                        borderRadius: 5
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            // Prepare data for Fab vs Machining comparison chart (doughnut chart)
            const fabTotalQty = selectedWeekData.fab.reduce((sum, row) => sum + (row.Qty || 0), 0);
            const machTotalQty = selectedWeekData.mach.reduce((sum, row) => sum + (row.Qty || 0), 0);
            console.log('Fab Total Qty for Chart:', fabTotalQty, 'Mach Total Qty for Chart:', machTotalQty);

            charts.comparison = new Chart(document.getElementById('comparisonChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Fabrication', 'Machining'],
                    datasets: [{
                        data: [fabTotalQty, machTotalQty],
                        backgroundColor: ['#667eea', '#764ba2']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // New: Prepare data for Scrap by Activity chart (Pie chart)
            const activityScrapData = {};
            selectedWeekData.fab.forEach(row => {
                activityScrapData[row['Activity Type']] = (activityScrapData[row['Activity Type']] || 0) + (row.Scrap || 0);
            });
            console.log('Activity Scrap Data for Chart:', activityScrapData);

            charts.scrapActivity = new Chart(document.getElementById('scrapActivityChart'), {
                type: 'pie',
                data: {
                    labels: Object.keys(activityScrapData),
                    datasets: [{
                        data: Object.values(activityScrapData),
                        backgroundColor: ['#e74c3c', '#2ecc71', '#3498db', '#f39c12', '#9b59b6'],
                        hoverOffset: 4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
            });
        }

        /**
         * Updates the analysis sections: Top Performers, Overall Scrap Analysis, and Scrap by Activity.
         * Calculates operator quantity and scrap rates.
         */
        function updateAnalysis() {
            if (!selectedWeekData) { // Clear analysis if no data
                document.getElementById('topOperators').innerHTML = '';
                document.getElementById('overallScrapAnalysis').innerHTML = '';
                document.getElementById('activityScrapAnalysis').innerHTML = '';
                return;
            }

            const operatorStats = {};
            selectedWeekData.fab.forEach(row => {
                if (!operatorStats[row.Operator]) operatorStats[row.Operator] = { qty: 0, scrap: 0 };
                operatorStats[row.Operator].qty += (row.Qty || 0);
                operatorStats[row.Operator].scrap += (row.Scrap || 0);
            });
            selectedWeekData.mach.forEach(row => {
                if (!operatorStats[row.Operator]) operatorStats[row.Operator] = { qty: 0, scrap: 0 }; // Initialize scrap for mach as 0, as it's not in your mach sheet
                operatorStats[row.Operator].qty += (row.Qty || 0);
            });


            // Sort operators by quantity to find top performers and display their scrap
            const topOps = Object.entries(operatorStats)
                               .sort(([,a], [,b]) => b.qty - a.qty)
                               .slice(0, 5);

            document.getElementById('topOperators').innerHTML = topOps.map(([name, stats]) => `
                <div class="operator-item">
                    <div>${name}</div>
                    <div>Q: ${stats.qty.toFixed(1)}</div>
                    <div>S: ${stats.scrap.toFixed(1)}</div>
                </div>
            `).join('');

            // Overall Scrap Analysis
            const totalQty = selectedWeekData.fab.reduce((sum, row) => sum + (row.Qty || 0), 0) + selectedWeekData.mach.reduce((sum, row) => sum + (row.Qty || 0), 0);
            const totalScrap = selectedWeekData.fab.reduce((sum, row) => sum + (row.Scrap || 0), 0);
            const scrapRate = totalQty > 0 ? ((totalScrap / totalQty) * 100).toFixed(1) : 0;

            document.getElementById('overallScrapAnalysis').innerHTML = `
                <div class="operator-item">
                    <div>Scrap Rate</div>
                    <div>${scrapRate}%</div>
                </div>
                <div class="operator-item">
                    <div>Total Scrap</div>
                    <div>${totalScrap.toFixed(1)}</div>
                </div>
            `;

            // New: Scrap by Activity Analysis
            const activityScrapData = {};
            selectedWeekData.fab.forEach(row => {
                activityScrapData[row['Activity Type']] = (activityScrapData[row['Activity Type']] || 0) + (row.Scrap || 0);
            });

            const sortedActivities = Object.entries(activityScrapData).sort(([,a], [,b]) => b - a);

            document.getElementById('activityScrapAnalysis').innerHTML = sortedActivities.map(([activity, scrap]) => `
                <div class="operator-item">
                    <div>${activity}</div>
                    <div>${scrap.toFixed(1)}</div>
                </div>
            `).join('');
        }

        /**
         * Refreshes the dashboard data by calling loadData() again.
         * This simulates re-fetching the latest data from the source.
         */
        function refreshData() {
            loadData(); // Re-fetch all data
        }

        // Initial data load when the page loads
        loadData();
    </script>
</body>
</html>
'''

display(HTML(html_content))


